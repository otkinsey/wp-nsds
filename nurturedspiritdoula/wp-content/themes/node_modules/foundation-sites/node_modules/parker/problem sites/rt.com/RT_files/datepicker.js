$(function(){
    var datapicerIcon = $('.datepicker .icon'),
    // из-за ie параметры фона пришлось прописать "хардкорно"
        datapicerIconBg = 'url("/static/img/static/icons.png") no-repeat scroll -239px -43px';

    $('.datepicker .dp-inp').datepicker({
        //changeMonth: true,
        //changeYear: true,
        showOtherMonths: true,
        selectOtherMonths: true,
        showOn: 'both',
        buttonText: '',
        dateFormat: 'yy-mm-dd',
        maxDate: 0,
        beforeShow: function(input) {
            datapicerIcon.css('background', 'none');
            
            setTimeout(function() {
                addChangeYear(input);
                
                // Исправляем позицию календаря
                $('#ui-datepicker-div').css({
                    left: ($('.datepicker .ui-datepicker-trigger').offset().left)+'px',
                    top: ($('.datepicker .ui-datepicker-trigger').offset().top)+'px'
                });
            }, 1);
            
            $('.datepicker .ui-datepicker-trigger').parent().addClass('datepicker-active');
        },
        onChangeMonthYear: function() {
            var input = this;
            setTimeout(function() {
                addChangeYear(input);
            }, 1);
        },
        onClose: function(date) {
            datapicerIcon.css('background', datapicerIconBg);
            if(date !== '') {
                window.location = ' /'+datepickerUrl+'/' + date.replace(/\//g, '-')+'/';
            }
            $('.datepicker .ui-datepicker-trigger').parent().removeClass('datepicker-active');
        }
    }).hide();
    $('.datepicker .icon').live('click',function(){
        $('.datepicker .dp-inp').datepicker('show');
    });
});

function addChangeYear(input) {
    var $header = $(input).datepicker('widget').find('.ui-datepicker-header');
    
    $('<a class="ui-datepicker-prevyear ui-corner-all"></a>')
        .append('<span class="ui-icon ui-icon-circle-arrow-w">Prev</span>')
        .hover(function() {
            $(this).addClass('ui-state-hover').addClass('ui-datepicker-prev-hover');
        }, function() {
            $(this).removeClass('ui-state-hover').removeClass('ui-datepicker-prev-hover');
        })
        .click(function() {
            $.datepicker._adjustDate(input, -12, 'M');
            return false;
        })
        .prependTo($header);
    
    var inst = $.datepicker._getInst(input);
    var disable = ($.datepicker._canAdjustMonth(inst, 12, inst.drawYear, inst.drawMonth))? '' : ' ui-state-disabled';
    $('<a class="ui-datepicker-nextyear ui-corner-all'+disable+'"></a>')
        .append('<span class="ui-icon ui-icon-circle-arrow-e">Next</span>')
        .hover(function() {
            $(this).addClass('ui-state-hover').addClass('ui-datepicker-next-hover');
        }, function() {
            $(this).removeClass('ui-state-hover').removeClass('ui-datepicker-next-hover');
        })
        .click(function() {
            $.datepicker._adjustDate(input, 12, 'M');
            return false;
        })
        .prependTo($header);
}