$(function () {
    $('.buttoned, button, input[type=button]').button();
    $(".autocomplete").autocomplete({
        minLength:2,
        select   :function (event, ui) {
            return true;
        },
        search   :function (event, ui) {
            //            console.debug($(this).data('field'));
            var source = '/' + requestController + '/autocomplete/field/' + $(this).data('field');
            $(this).autocomplete("option", "source", source);
            var term = this.value.value;
            return true;
        }
    });
    
    // Datepicker
    $("input.datetimepickered").filter(":not(.hasDatepicker)").each(function () {
        var inp = $(this);
        var btn = $("<div>").addClass('closethick')
            .click(function () {
                inp.val('');
            })
            .button({
                icons:{
                    primary:"ui-icon-closethick"
                },
                text :false
            });
        inp.datetimepicker({
            dateFormat:"yy-mm-dd",
            timeFormat:"hh:mm"
        }).after(btn);
    });
    $("input.datepickered").filter(":not(.hasDatepicker)").each(function () {
        var inp = $(this);
        var btn = $("<div>").addClass('closethick')
            .click(function () {
                inp.val('');
            })
            .button({
                icons:{
                    primary:"ui-icon-closethick"
                },
                text :false
            });
        inp.datepicker({
            dateFormat:"yy-mm-dd"
        }).after(btn);
    });

    // RT Asks
    var $form = $('div.polling form');
    if ($form.length > 0) {
        $form.submit(function() {
            var $form = $(this);
            var $answer = $('input[name="vote"]:checked', $form);

            if ($answer.length == 1) {
                $.ajax({
                    type: 'POST',
                    url: '/poll/vote/',
                    data: {
                        answer: $answer.val(),
                        poll: $('input[name="poll_id"]', $form).val()
                    },
                    dataType: 'json',
                    success: function(data) {
                        $('div.wrap', $form).hide();
                        $('h2.status', $form).show();
                        $('div.results', $form).show();
                        $('a.hide-results', $form).hide();
                    },
                    error: function(obj, error, data) {
                    }
                });
            }

            return false;
        });

        var poll_id = $('input[name="poll_id"]', $form).val();
        var voted = getCookie('poll_' + poll_id) !== undefined;
        if (voted) {
            $('div.results', $form).show();
        } else {
            $('div.wrap', $form).show();
        }

        $('a.view-results', $form).click(function(){
            var $form = $('div.polling form');
            $('div.wrap', $form).hide();
            $('div.results', $form).show();
            $('a.hide-results', $form).show();
            return false;
        });

        $('a.hide-results', $form).click(function(){
            var $form = $('div.polling form');
            $('div.results', $form).hide();
            $('div.wrap', $form).show();
            return false;
        });
    }

    // News
    if ($('div.doc-page').length > 0) {
        // Image captions
        $('div.content div.cont-wp img[alt][alt!=""]').each(function() {
            var id = $(this).parent().attr('id');
            if (id === undefined || id.indexOf('recaptcha') == -1) {
                addImgCaption(this);
            }
        });
        $('div.grey small').hide();
        
        // Lightbox
        $('div.content div.cont-wp a[href$=".jpg"]').click(function() {
            if ($('div.lightbox').length == 0) {
                $('<div></div>').addClass('lightbox-overlay').click(function() {
                    $('div.lightbox-overlay').hide();
                    $('div.lightbox').hide();
                }).appendTo('body');
                var $lightbox = $('<div></div>').addClass('lightbox');
                $('<img></img>').addClass('photo').load(function() {
                    var left = Math.round(($(window).width() - $(this).width())/2);
                    var top = Math.round(($(window).height() - $(this).height())/2);
                    $('div.lightbox').css({
                        left: left+'px',
                        top: top+'px'
                    });
                }).appendTo($lightbox);
                $('<a></a>').attr('href', '').html('&times;').addClass('close').click(function() {
                    $('div.lightbox-overlay').hide();
                    $('div.lightbox').hide();
                    return false;
                }).appendTo($lightbox);
                $lightbox.appendTo('body');
            }
            var $lightbox = $('div.lightbox');
            $('img', $lightbox).attr('src', this.href);
            $lightbox.show();
            $('div.lightbox-overlay').show();
            return false;
        });
        
        // Youtube video
        $('div.content div.cont-wp iframe').each(function() {
            if (this.src.indexOf('youtube.com/embed/') != -1) {
                $(this).wrap('<div class="ration_16-9" />');
            }
        });
        
        // Read more links
        if (typeof readMore != 'undefined' && readMore) {
            var url = [];
            $('div.content div.cont-wp a:contains("MORE:")').each(function() {
                if (!$(this).parent().hasClass('read-more-include')) {
                    url.push(this.pathname);
                }
            });
            if (url.length > 0) {
                $.ajax({
                    url: '/news/info/',
                    data: {
                        url: url
                    },
                    success: function(data) {
                        if (data.Errors.length == 0) {
                            for (var i=0; i<data.Body.news.length; i++) {
                                var doc = data.Body.news[i];
                                $('div.content div.cont-wp a:contains("MORE:")').each(function() {
                                    if (!$(this).parent().hasClass('read-more-include') && this.pathname == doc.url) {
                                        var $a = $(this);
                                        $a.empty();
                                        $a.wrap('<div class="read-more-include"></div>');
                                        $('<span></span>').addClass('read-more-include_header').html('Read more').insertBefore($a);
                                        $('<img></img>').attr('src', doc.image).appendTo($a);
                                        $('<span></span>').html(doc.name).appendTo($a);
                                    }
                                });
                            }
                        }
                    }
                });
            }
        }
    }

    // Gallery
    $('div.gallery div.images-wrap dl.figure img').load(function() {
        var imgHeight = $(this).height();
        var blockHeight = $(this).parent().parent().height();
        var marginTop = Math.round((blockHeight - imgHeight)/2);
        $(this).parent().css('padding-top', marginTop+'px');
    });
    
    // Get short url
    $('#get-short-url a.get').click(function() {
        var url = $(this).data('url');
        $.ajax({
            url: 'http://on.rt.com/',
            data: {
                url: url
            },
            success: function(code) {
                $('#get-short-url a.get').hide();
                $('#get-short-url div.url').html('http://on.rt.com/'+code).show();
            }
        });
        return false;
    });
    $('#get-short-url div.url').click(function() {
        if (document.selection) {
            var range = document.body.createTextRange();
            range.moveToElementText(this);
            range.select();
        } else if (window.getSelection) {
            var range = document.createRange();
            range.selectNode(this);
            window.getSelection().addRange(range);
        }
    });

    // More updates (old)
    if (typeof morePos != 'undefined') {
        $('div.b-buttons_links.more_doc a').click(function() {
            $.ajax({
                type: 'GET',
                url: '/news/more/',
                data: {
                    pos: morePos,
                    doc_id: doc_id
                },
                dataType: 'json',
                success: function(data) {
                    if (data.Errors.length == 0) {
                        $('div.b-buttons_links.more_doc').first().before(data.Body.text);
                        if (data.Body.pos) {
                            morePos = data.Body.pos;
                        } else {
                            $('div.b-buttons_links.more_doc').hide();
                        }
                    }
                },
                error: function(obj, error, data) {
                }
            });
            return false;
        });
    }
    
    // More updates
    if (typeof updatePage != 'undefined') {
        $('div.b-buttons_links.more_updates a').click(function() {
            $.ajax({
                type: 'GET',
                url: '/news/updates/',
                data: {
                    page: updatePage.current + 1,
                    doc_id: doc_id,
                    lastdate: updatePage.lastdate
                },
                dataType: 'json',
                success: function(data) {
                    if (data.Errors.length == 0) {
                        $('div.b-buttons_links.more_updates').first().before(data.Body.text);
                        if (data.Body.page < updatePage.total) {
                            updatePage.current = parseInt(data.Body.page);
                        } else {
                            $('div.b-buttons_links.more_updates').hide();
                        }
                    }
                },
                error: function(obj, error, data) {
                }
            });
            return false;
        });
    }
    
    // More news
    $('div.b-buttons_links.more_news a').click(function() {
        $('div.b-buttons_links.more_news a').hide();
        $('div.b-buttons_links.more_news span.loading').show();
        $.ajax({
            type: 'GET',
            url: $(this).attr('href'),
            data: {
                page: $(this).data('page'),
                section: $(this).data('section')
            },
            dataType: 'json',
            success: function(data) {
                if (data.Errors.length == 0) {
                    $('div.b-buttons_links.more_news').first().before(data.Body.text);
                    $('div.b-buttons_links.more_news a').data('page', data.Body.page+1);
                    $('div.b-buttons_links.more_news a').show();
                    $('div.b-buttons_links.more_news span.loading').hide();
                    getCommentsCount('a.comments', '<span class="count-comment">{%COUNT%}</span>');
                }
            },
            error: function(obj, error, data) {
            }
        });
        return false;
    });

    // Extension
    var $extension = $('div.b-main_extension');

    // Close
    $('a.b-main_extension_close', $extension).click(function() {
        setCookie('hide_ce', true, 365);
        $extension.hide();
        return false;
    });

    // Chrome
    if (navigator.userAgent.indexOf('Chrome') > -1 && !getCookie('hide_ce')) {
        // Check install
        $.ajax({
            url: 'chrome-extension://kloiceblkijlknknaibcaieiicafajlo/check.html',
            error: function() {
                // Init and show
                $extension.addClass('chrome');
                $('a.b-main_extension_button', $extension).attr('href', 'https://chrome.google.com/webstore/detail/rt-news/kloiceblkijlknknaibcaieiicafajlo');
                $('p.b-main_extension_message span', $extension).html('Chrome');
                $extension.addClass('visible');
            }
        });
    }

    // Opera
    if (navigator.userAgent.indexOf('Opera') > -1 && !getCookie('hide_ce')) {
        // Check install
        var ver = / Version\/(\d+)\./.exec(navigator.userAgent);
        if (typeof extensionInstalled == 'undefined' && ver[1] && ver[1] <= 12) {
            // Init and show
            $extension.addClass('opera');
            $('a.b-main_extension_button', $extension).attr('href', 'https://addons.opera.com/extensions/details/rt-news/');
            $('p.b-main_extension_message span', $extension).html('Opera');
            $extension.addClass('visible');
        }
    }

    // Firefox
    if (navigator.userAgent.indexOf('Firefox') > -1 && !getCookie('hide_ce')) {
        // Init and show
        $extension.addClass('firefox');
        $('a.b-main_extension_button', $extension).attr('href', 'https://addons.mozilla.org/firefox/addon/rt-news/');
        $('p.b-main_extension_message span', $extension).html('Firefox');
        $extension.addClass('visible');
    }

    // Full transcript
    $('div.full_transcript a').click(function() {
        $(this).hide();
        $('div.full_transcript_text').slideDown(200);
        return false;
    });
});

function addImgCaption(img) {
    if ($(img).parent().hasClass('article_img')) {
        return;
    }
    var $wrap = $(img).wrap('<div class="article_img" />').parent();
    var $footer = $('<p class="article_img_footer" />').text(img.alt);

    var float = $(img).css('float');
    $(img).css('float', 'none');
    $wrap.css('float', float);

    var margin = $(img).css('margin');
    $(img).css('margin', 0);
    $wrap.css('margin', margin);

    $(img).after($footer);
}

// get cookie
function getCookie(name) {
    var matches = document.cookie.match(new RegExp("(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"));
    return matches ? decodeURIComponent(matches[1]) : undefined;
}

// set cookie
function setCookie(name, value, exdays) {
    var exdate = new Date();
    exdate.setDate(exdate.getDate() + exdays);
    document.cookie = name + "=" + escape(value) + ((exdays==null) ? "" : "; expires="+exdate.toUTCString()) + "; path=/";
}

// get selection text (for quote)
function getSelectionText() {
    var text = "";
    if (window.getSelection) {
        text = window.getSelection().toString();
    } else if (document.selection && document.selection.type != "Control") {
        text = document.selection.createRange().text;
    }
    return text;
}

// Notice controller
Notice = {
    err:function (text, title, duration) {
        text = ( typeof title != 'undefined' ? '<b>' + title + '</b><br />' : '') + text;
        var timeout = (duration == undefined) ? 15 : duration;
        /*$.achtung({
            message  :text,
            timeout  :timeout,
            className:'Fail'
        });*/
    },

    warn:function (text, title, duration) {
        text = ( typeof title != 'undefined' ? '<b>' + title + '</b><br />' : '') + text;
        var timeout = (duration == undefined) ? 15 : duration;
        /*$.achtung({
            message  :text,
            timeout  :timeout,
            className:'Warning'
        });*/
    },

    ok:function (text, title, duration) {
        text = ( typeof title != 'undefined' ? '<b>' + title + '</b><br />' : '') + text;
        var timeout = (duration == undefined) ? 15 : duration;
        /*$.achtung({
            message  :text,
            timeout  :timeout,
            className:'Success'
        });*/
    },

    msg:function (text, title, duration) {
        text = ( typeof title != 'undefined' ? '<b>' + title + '</b><br />' : '') + text;
        var timeout = (duration == undefined) ? 15 : duration;
        /*$.achtung({
            message  :text,
            timeout  :timeout,
            className:'Wait'
        });*/
    },

    custom:function (options) {
        /*$.achtung(options);*/
    }
};

function AJAXReplyError(reply) {
    if (reply.Errors.length > 0) {
        for (var index = 0; index < reply.Errors.length; index++) {
            Notice.err(reply.Errors[index], 'Error');
        }
        return true;
    }
    return false;
}

$(function(){
    $('.main-nav .button').live("click", function(){
        if($('.main-nav ul').hasClass('active')) {
            $('.main-nav ul').removeClass('active');
        } else {
            $('.main-nav ul').addClass('active');
        }
    });

    var marquee = $('.marquee');
    marquee.wrapInner("<span>");
    marquee.append(marquee.find("span").clone());
    marquee.wrapInner("<div>");
    var reset = function() {
        $(this).css("margin-left", "0%");
        $(this).animate({ "margin-left": "-900px" }, 12000, 'linear', reset);
    };
    reset.call(marquee.find("div"));
});

$(function(){
  $("#showSearch").on('click',function(){
    $(this).toggleClass("active");
    $("#mobileSearch").toggleClass("off");
  });

  $("#showNav").on('click',function(){
    $("body").css('overflow','hidden');
    $("#mobileNav").show();
  });

  $("#hideNav").on('click',function(){
    $("body").css('overflow','visible');
    $("#mobileNav").hide();
  });

  $("#mobileNav").on('click',function(){
    $(this).hide();
    $("body").css('overflow','visible');
  });
});

/**
 * Вставляет счётчики комментариев
 */
function getCommentsCount(selector, label) {
    // Значение по умолчанию
    if (typeof label == 'undefined') {
        label = '{%COUNT%}';
    }
    
    // Список id
    var ids = [];
    $(selector).each(function() {
        ids.push($(this).data('id'));
    });
    
    // Отправляем запрос
    if (ids.length > 0) {
        $.ajax({
            type: 'GET',
            url: '/comment/count/',
            dataType: 'json',
            data: {
                ids: ids
            },
            success: function(data) {
                if (data.Errors.length == 0) {
                    $(selector).each(function() {
                        var id = $(this).data('id');
                        if (typeof data.Body.ids[id] != 'undefined' && data.Body.ids[id] > 0) {
                            $(this).html(label.replace('{%COUNT%}', data.Body.ids[id])).show();
                        }
                    });
                }
            }
        });
    }
}